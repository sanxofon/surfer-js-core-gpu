<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <script type="text/javascript" src="./vendor/CindyJS/v0.8.8/Cindy.js"></script>
  <script type="text/javascript" src="./vendor/CindyJS/v0.8.8/CindyGL.js"></script>
  <script type="text/javascript" src="./vendor/CindyJS/v0.8.8/symbolic.js"></script>
  <!-- iro.js Color Picker Library -->
  <script src="https://cdn.jsdelivr.net/npm/@jaames/iro@5"></script>
  <style>
    #inp {
      font-size: 1.3em;
      display: block;
      width: 520px;
      margin-left: 30px;
    }

    .surface {
      width: 500px;
      height: 500px;
      display: inline-block;
      resize: both;
      overflow: auto;
    }

    .slider {
      width: 20px;
      height: 500px;
      writing-mode: bt-lr;
      appearance: slider-vertical;
      -webkit-appearance: slider-vertical;
    }

    /* Color picker styling */
    .color-picker-section {
      display: flex;
      gap: 0;
      flex-wrap: wrap;
    }

    .color-picker-item {
      text-align: center;
    }

    .color-picker-item h3 {
      margin: 0 0 15px 0;
      font-size: 14px;
      font-weight: 600;
      color: #333;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
  </style>
</head>

<body style="font-family: Arial">
  <div>
    <span id="container"></span>
    <input type="range" min="-0.2" value="1.0" max="1.2" step="0.001" class="slider" id="sliderParamA"
      orient="vertical" />
    <input type="range" min="0.3" value="1.0" max="1.0" step="0.001" class="slider" id="sliderAlpha"
      orient="vertical" />
    <input type="range" min="-3" value="-1.0" max="0.5" step="0.001" class="slider" id="sliderZoom" orient="vertical" />
  </div>

  <input type="text" id="inp"
    value="(x^2+y^2+z^2-(0.5+a)^2)^2-(3*((0.5+a)^2)-1)/(3-((0.5+a)^2))*(1-z-sqrt(2)*x)*(1-z+sqrt(2)*x)*(1+z+sqrt(2)*y)*(1+z-sqrt(2)*y)"
    size="60" />
  <div class="color-picker-section">
    <div class="color-picker-item">
      <div id="picker-primary"></div>
      <h3>Primary Color</h3>
    </div>
    <div class="color-picker-item">
      <div id="picker-accent"></div>
      <h3>Accent Color</h3>
    </div>
    <div class="color-picker-item">
      <div id="picker-secondary"></div>
      <h3>Secondary Color</h3>
    </div>
  </div>

  <script type="module">
    import SurferCoreGpu from './dist/surfer-core-gpu-bundled-cindyjs.mjs';

    const container = document.getElementById('container');

    const input = document.getElementById('inp');

    const sliderParamA = document.getElementById('sliderParamA');
    const sliderAlpha = document.getElementById('sliderAlpha');
    const sliderZoom = document.getElementById('sliderZoom');

    // Helper function to convert iro.js color to RGB array (0-1 range)
    function iroToRgb(iroColor) {
      return [
        iroColor.rgb.r / 255,
        iroColor.rgb.g / 255,
        iroColor.rgb.b / 255
      ];
    }

    async function init() {
      const surferCoreGpu = await SurferCoreGpu.create(container, 512, 512);
      surferCoreGpu.setExpression(input.value);
      surferCoreGpu.setParameter('a', sliderParamA.valueAsNumber);
      surferCoreGpu.setZoom(Math.pow(2, sliderZoom.valueAsNumber));
      surferCoreGpu.setAlpha(sliderAlpha.valueAsNumber);
      surferCoreGpu.element.classList.add('surface');
      console.log(surferCoreGpu);

      // Create iro.js color pickers
      const pickerPrimary = new iro.ColorPicker('#picker-primary', {
        width: 200,
        color: '#4d80ff',
        layout: [
          {
            component: iro.ui.Wheel,
            options: {}
          },
          {
            component: iro.ui.Slider,
            options: {
              sliderType: 'value'
            }
          }
        ]
      });

      const pickerAccent = new iro.ColorPicker('#picker-accent', {
        width: 200,
        color: '#ff3319',
        layout: [
          {
            component: iro.ui.Wheel,
            options: {}
          },
          {
            component: iro.ui.Slider,
            options: {
              sliderType: 'value'
            }
          }
        ]
      });

      const pickerSecondary = new iro.ColorPicker('#picker-secondary', {
        width: 200,
        color: '#a3b845',
        layout: [
          {
            component: iro.ui.Wheel,
            options: {}
          },
          {
            component: iro.ui.Slider,
            options: {
              sliderType: 'value'
            }
          }
        ]
      });

      // Wire up surface parameter sliders
      input.addEventListener('keypress', (event) =>
        event.code === 'Enter'
          ? surferCoreGpu.setExpression(input.value)
          : false,
      );
      sliderParamA.addEventListener('input', () =>
        surferCoreGpu.setParameter('a', sliderParamA.valueAsNumber),
      );
      sliderAlpha.addEventListener('input', () =>
        surferCoreGpu.setAlpha(sliderAlpha.valueAsNumber),
      );
      sliderZoom.addEventListener('input', () =>
        surferCoreGpu.setZoom(Math.pow(2, sliderZoom.valueAsNumber)),
      );

      // Wire up color picker events
      pickerPrimary.on('color:change', (color) => {
        surferCoreGpu.setPrimaryColor(iroToRgb(color));
      });

      pickerAccent.on('color:change', (color) => {
        surferCoreGpu.setAccentColor(iroToRgb(color));
      });

      pickerSecondary.on('color:change', (color) => {
        surferCoreGpu.setSecondaryColor(iroToRgb(color));
      });
    }
    init().then();
  </script>
</body>

</html>