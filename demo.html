<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Surfer Touch Interface</title>
  
  <!-- Local Dependencies -->
  <script type="text/javascript" src="./vendor/CindyJS/v0.8.8/Cindy.js"></script>
  <script type="text/javascript" src="./vendor/CindyJS/v0.8.8/CindyGL.js"></script>
  <script type="text/javascript" src="./vendor/CindyJS/v0.8.8/symbolic.js"></script>
  <!-- <script src="https://cdn.jsdelivr.net/npm/@jaames/iro@5"></script> -->
  <script src="./vendor/iro.5.5.2.js"></script> 
  <link rel="stylesheet" href="./keyboard.css" />

  <style>
    :root {
      --border-thin: 1px solid #ddd;
      --bg-color: #f4f4f4;
      --key-bg: #fff;
      --key-active: #e0e0e0;
      --accent-red: #ff6b6b;
    }

    * {
      box-sizing: border-box;
      -webkit-user-select: none; /* Prevent text selection on touch */
      user-select: none; /* Prevent text selection on touch */
    }

    body {
      margin: 0;
      padding: 10px;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      
      /* Main Layout Grid */
      display: grid;
      grid-template-columns: 100vh 1fr; /* Left side is square (based on height), Right fills rest */
      gap: 15px;
    }

    /* --- 1. Main Graphic Display --- */
    #container {
      width: 100%;
      height: 100%;
      position: relative;
      border-radius: 4px;
      overflow: hidden;
    }

    /* Ensure the canvas generated by JS fills the container */
    #container canvas {
      width: 100% !important;
      height: 100% !important;
      outline: none;
    }

    /* --- Right Panel Container --- */
    .controls-panel {
      display: grid;
      grid-template-rows: 1fr auto auto; /* Sliders/Colors (flex), Input (fixed), Keyboard (fixed) */
      gap: 15px;
      height: 100%;
    }

    /* Top Section of Right Panel (Sliders + Colors) */
    .top-controls {
      display: grid;
      grid-template-columns: 1fr 2fr;
      gap: 15px;
      min-height: 0; /* Important for nested scrolling/flex */
    }

    /* --- 2. Vertical Sliders Section --- */
    .sliders-wrapper {
      padding: 10px;
      display: flex;
      flex-direction: row;
      justify-content: space-around;
      align-items: center;
    }

    .slider-column {
      display: flex;
      flex-direction: column;
      align-items: center;
      height: 100%;
      width: 30%;
    }

    .slider-track {
      flex-grow: 1; /* Fill available height */
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 10px 0;
    }

    /* Custom Vertical Slider Styling */
    input[type=range][orient=vertical] {
      writing-mode: bt-lr; /* IE/Edge */
      -webkit-appearance: slider-vertical; /* Webkit */
      appearance: slider-vertical;
      width: 8px;
      height: 100%;
      outline: none;
    }

    .slider-icon {
      width: 32px;
      height: 32px;
      margin-top: 5px;
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      font-size: 20px;
      text-align: center;
      line-height: 32px;
      font-weight: bold;
    }

    /* Icon Fallbacks (if images missing) */
    .icon-arg-a::before { content: "a"; }
    .icon-opacity::before { content: "‚ñí"; }
    .icon-zoom::before { content: "üîç"; }

    /* Override with background images if available */
    .icon-arg-a { background-image: url("./img/a-black.svg"); }
    .icon-opacity { background-image: url("./img/opacity-black-cropped.svg"); }
    .icon-zoom { background-image: url("./img/zoom-black-cropped.svg"); }
    
    /* Hide text fallback if image loads (requires JS or simpler css hack, leaving text as backup) */
    .icon-arg-a, .icon-opacity, .icon-zoom {
      color: transparent;
      background-size: 60%;
    } 

    /* --- 3. Color Picker Section --- */
    .color-section {
      display: flex;
      flex-direction: row;
      justify-content: space-evenly; /* Distribute vertically */
      align-items: center;
    }
    
    .color-picker-item {
      text-align: center;
    }
    
    .color-picker-item h3 {
      margin: 0 0 15px 0;
      font-size: 14px;
      font-weight: 600;
      color: #333;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    /* --- 4. Input Section --- */
    .input-section {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 5px;
    }

    #inp {
      border: var(--border-thin);
      border-radius: 6px;
      flex-grow: 1;
      height: 50px;
      font-size: 1.2rem;
      padding: 0 10px;
      width: 100%; /* Fix width issue */
    }

    #inp:focus {
      outline: none;
    }

    .icon-enter {
      width: 50px;
      height: 50px;
      background-image: url("./img/paper-plane-black.svg");
      background-size: 60%;
      background-repeat: no-repeat;
      background-position: center;
      cursor: pointer;
      border-radius: 4px;
      background-color: #6ffb53;
    }
    .icon-enter:active {
      background-color: #ddd;
    }

    /* --- 5. Keyboard Section --- */
    .keyboard-container {
      padding: 4px;
    }

    .icon-clear {
      width: 24px;
      height: 24px;
      background-image: url("./img/eraser-black.svg"); /* Will be white via filter if SVG, otherwise handled by CSS */
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
    }

    /* Responsiveness for slight aspect ratio changes */
    @media (max-aspect-ratio: 16/10) {
      body {
        grid-template-columns: 1fr;
        grid-template-rows: 50vh 1fr;
        overflow-y: auto;
      }
      #container { width: 100%; height: 100%; }
      /* Adjust vertical slider height on small screens */
      .sliders-wrapper { min-height: 200px; }
    }

  </style>
</head>

<body>

  <!-- 1. Graphic Display (Left Column) -->
  <div id="container"></div>

  <!-- Right Controls Panel -->
  <div class="controls-panel">

    <!-- Top Section: Sliders & Colors -->
    <div class="top-controls">
      
      <!-- 2. Vertical Sliders -->
      <div class="sliders-wrapper">
        <div class="slider-column">
          <div class="slider-track">
            <input title="Argument a" type="range" min="-0.2" value="1.0" max="1.2" step="0.001" id="sliderParamA" orient="vertical" />
          </div>
          <div class="slider-icon icon-arg-a" title="Argument a"></div>
        </div>

        <div class="slider-column">
          <div class="slider-track">
            <input title="Opacity" type="range" min="0.3" value="1.0" max="1.0" step="0.001" id="sliderAlpha" orient="vertical" />
          </div>
          <div class="slider-icon icon-opacity" title="Opacity"></div>
        </div>

        <div class="slider-column">
          <div class="slider-track">
            <input title="Zoom" type="range" min="-3" value="-1.0" max="0.5" step="0.001" id="sliderZoom" orient="vertical" />
          </div>
          <div class="slider-icon icon-zoom" title="Zoom"></div>
        </div>
      </div>

      <!-- 3. Color Pickers -->
      <div class="color-section">
        <div class="color-picker-item">
          <div id="picker-primary"></div>
        </div>
        <div class="color-picker-item">
          <div id="picker-secondary"></div>
        </div>
        <!-- <div class="color-picker-item">
            <div id="picker-accent"></div>
        </div> -->
      </div>

    </div>

    <!-- 4. Input Section -->
    <div class="input-section">
      <input title="Formula" type="text" id="inp"
        value="(x^2+y^2+z^2-(0.5+a)^2)^2-(3*((0.5+a)^2)-1)/(3-((0.5+a)^2))*(1-z-sqrt(2)*x)*(1-z+sqrt(2)*x)*(1+z+sqrt(2)*y)*(1+z-sqrt(2)*y)" />
      <div class="icon-enter" id="inp-enter" title="Enter"></div>
    </div>

    <!-- 5. Keyboard Section -->
    <div class="keyboard-container">
      <div class="keyboard">
        <!-- Row 1: Numbers -->
        <div class="key-row">
          <button class="key" data-val="1">1</button>
          <button class="key" data-val="2">2</button>
          <button class="key" data-val="3">3</button>
          <button class="key" data-val="4">4</button>
          <button class="key" data-val="5">5</button>
          <button class="key" data-val="6">6</button>
          <button class="key" data-val="7">7</button>
          <button class="key" data-val="8">8</button>
          <button class="key" data-val="9">9</button>
          <button class="key" data-val="0">0</button>
        </div>
        
        <!-- Row 2: Operators -->
        <div class="key-row">
          <button class="key" data-val=".">.</button>
          <button class="key" data-val="(">(</button>
          <button class="key" data-val=")">)</button>
          <button class="key" data-val="+">+</button>
          <button class="key" data-val="-">-</button>
          <button class="key" data-val="*">*</button>
          <button class="key" data-val="/">/</button>
          <button class="key" data-val="^">^</button>
          <button class="key" data-val="sqrt(2)">‚àö</button>
        </div>
        
        <!-- Row 3: Letters and Actions -->
        <div class="key-row">
          <button class="key" data-val="x">x</button>
          <button class="key" data-val="y">y</button>
          <button class="key" data-val="z">z</button>
          <button class="key" data-val="a">a</button>
          <div class="key-spacer"></div>
          <button class="key action" data-action="left">&lt;</button>
          <button class="key action" data-action="right">&gt;</button>
          <button class="key action delete" data-action="delete">‚å´</button>
          <button class="key action clear" data-action="clear"><span class="icon-clear"></span></button>
          <button class="key enter" data-action="enter"><span class="icon-enter"></span></button>
        </div>
      </div>
    </div>

  </div>

  <!-- Script Logic -->
  <script type="module">
    // Assuming SurferCoreGpu file exists locally as per your demo
    import SurferCoreGpu from './dist/surfer-core-gpu-bundled-cindyjs.mjs';
    
    const container = document.getElementById('container');
    const input = document.getElementById('inp');
    const inputEnter = document.getElementById('inp-enter');
    
    const sliderParamA = document.getElementById('sliderParamA');
    const sliderAlpha = document.getElementById('sliderAlpha');
    const sliderZoom = document.getElementById('sliderZoom');
    
    function iroToRgb(iroColor) {
      return [
        iroColor.rgb.r / 255,
        iroColor.rgb.g / 255,
        iroColor.rgb.b / 255
      ];
    }

    async function init() {
      // Initialize Surface
      // Using clientWidth/Height to ensure it fits the CSS grid cell
      const width = container.clientWidth;
      const height = container.clientHeight;
      
      const surferCoreGpu = await SurferCoreGpu.create(container, width, height);
      surferCoreGpu.setExpression(input.value);
      surferCoreGpu.setParameter('a', sliderParamA.valueAsNumber);
      surferCoreGpu.setZoom(Math.pow(2, sliderZoom.valueAsNumber));
      surferCoreGpu.setAlpha(sliderAlpha.valueAsNumber);
      
      // Initialize Color Pickers
      const pickerPrimary = new iro.ColorPicker('#picker-primary', {
        width: 140, // Adjusted size for layout
        color: '#0000ff',
        layout: [
          { component: iro.ui.Wheel, options: {} },
          { component: iro.ui.Slider, options: { sliderType: 'value' } }
        ]
      });
      
      const pickerSecondary = new iro.ColorPicker('#picker-secondary', {
        width: 140, // Adjusted size for layout
        color: '#ff0000',
        layout: [
          { component: iro.ui.Wheel, options: {} },
          { component: iro.ui.Slider, options: { sliderType: 'value' } }
        ]
      });

      pickerPrimary.on('color:change', (color) => {
        surferCoreGpu.setPrimaryColor(iroToRgb(color));
      });
      
      pickerSecondary.on('color:change', (color) => {
        surferCoreGpu.setSecondaryColor(iroToRgb(color));
      });

      
      // Events
      const updateExpression = () => surferCoreGpu.setExpression(input.value);
      
      input.addEventListener('keypress', (e) => e.code === 'Enter' ? updateExpression() : null);
      inputEnter.addEventListener('click', updateExpression);
      
      sliderParamA.addEventListener('input', () => surferCoreGpu.setParameter('a', sliderParamA.valueAsNumber));
      sliderAlpha.addEventListener('input', () => surferCoreGpu.setAlpha(sliderAlpha.valueAsNumber));
      sliderZoom.addEventListener('input', () => surferCoreGpu.setZoom(Math.pow(2, sliderZoom.valueAsNumber)));
      
      // Keyboard Logic
      const keys = document.querySelectorAll('.key');
      keys.forEach(key => {
        key.addEventListener('click', (e) => {
          e.preventDefault(); // Prevent focus loss issues on touch
          input.focus();
          
          const val = key.getAttribute('data-val');
          const action = key.getAttribute('data-action');
          
          if (val) {
            insertText(val);
          } else if (action) {
            handleAction(action);
          }
        });
      });
      
      function insertText(text) {
        const start = input.selectionStart;
        const end = input.selectionEnd;
        const currentValue = input.value;
        input.value = currentValue.substring(0, start) + text + currentValue.substring(end);
        const newPos = start + text.length;
        input.setSelectionRange(newPos, newPos);
      }
      
      function handleAction(action) {
        const start = input.selectionStart;
        const end = input.selectionEnd;
        const value = input.value;
        
        if (action === 'delete') {
          if (start === end && start > 0) {
            input.value = value.substring(0, start - 1) + value.substring(end);
            input.setSelectionRange(start - 1, start - 1);
          } else if (start !== end) {
            input.value = value.substring(0, start) + value.substring(end);
            input.setSelectionRange(start, start);
          }
        } else if (action === 'left') {
          if (start > 0) input.setSelectionRange(start - 1, start - 1);
        } else if (action === 'right') {
          if (start < value.length) input.setSelectionRange(start + 1, start + 1);
        } else if (action === 'clear') {
          input.value = "";
        } else if (action === 'enter') {
          surferCoreGpu.setExpression(input.value);
        }
      } 
    
    }

    init();
  </script>
</body>
</html>